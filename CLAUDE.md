# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is the **Anava Vision Infrastructure Deployment Tool** - a complete, autonomous desktop application that allows customers to deploy Anava's camera authentication infrastructure to their own Google Cloud Platform projects. The system achieves **100% customer autonomy** with zero dependencies on Anava-hosted services.

### Architecture Summary

**Electron Desktop App** → **Customer's GCP Project** → **Camera Authentication Flow**

The app authenticates with the customer's Google Cloud account, deploys a complete authentication infrastructure via Terraform, and configures Axis cameras to authenticate with the customer's own Google Cloud services.

## Key Directories Structure

```
terraform-installer/
├── main.tf, outputs.tf, variables.tf    # Root Terraform module
├── anava-desktop-app/                   # Electron desktop application
│   ├── src/main/                       # Electron main process
│   ├── src/renderer/                   # React frontend
│   └── terraform-module/               # Embedded Terraform module
├── functions/                          # Cloud Functions source code
│   ├── device-auth/                    # Firebase custom token generation
│   └── token-vending-machine/          # WIF to GCP token exchange
├── test-*.sh                          # Authentication flow test scripts
└── *.md                               # Comprehensive documentation
```

## Core Components

### 1. Terraform Infrastructure (Root Level)
- **Purpose**: Deploys complete GCP infrastructure to customer's project
- **Key Resources**: API Gateway, Cloud Functions, Firebase, Workload Identity Federation, IAM
- **Entry Point**: `main.tf`
- **Outputs**: API Gateway URL, API keys, service account emails, Firebase config

### 2. Electron Desktop App
- **Main Process**: `anava-desktop-app/src/main/main.js` - Node.js backend
- **Renderer**: `anava-desktop-app/src/renderer/` - React frontend with Material-UI
- **Key Features**: GCP authentication, Terraform deployment, camera configuration, Firebase setup guidance

### 3. Authentication Flow (3-Step Process)
1. **Device Auth**: Camera → API Gateway → Firebase custom token
2. **Firebase Exchange**: Custom token → Firebase ID token  
3. **Token Vending**: Firebase ID token → GCP access token (via WIF)

## Build Commands

### Electron App Development
```bash
cd anava-desktop-app
npm install                    # Install dependencies
npm run dev                    # Development mode (hot reload)
npm run build                  # Production build
npm run build-mac             # Build macOS installer
npm run build-win             # Build Windows installer
npm run build-linux           # Build Linux AppImage
```

### React Frontend Only
```bash
cd anava-desktop-app/src/renderer
npm install                    # Install React dependencies
npm start                     # Development server (port 3000)
npm run build                 # Production React build
npm test                      # Run React tests
```

### Terraform Infrastructure
```bash
terraform init                # Initialize Terraform
terraform plan                # Preview changes
terraform apply               # Deploy infrastructure
terraform output -json        # Get deployment outputs
terraform destroy             # Tear down infrastructure
```

## Testing Commands

### Authentication Flow Testing
```bash
./test-firebase-exchange.sh    # Test complete 3-step auth flow
./test-api-gateway.sh         # Test API Gateway endpoints
./test-cloud-run-direct.sh    # Test Cloud Functions directly
```

### Infrastructure Validation
```bash
./validate-deployment.sh      # Validate deployed infrastructure
./diagnose-api-gateway.sh     # Diagnose API Gateway issues
```

## Key Technical Concepts

### Authentication Architecture
- **Workload Identity Federation (WIF)**: Allows cameras to exchange Firebase tokens for GCP access tokens
- **API Gateway**: Public endpoints with API key authentication
- **Service Accounts**: Dedicated accounts for each component (device-auth, tvm, vertex-ai)
- **Firebase Custom Tokens**: Generated by device-auth function for camera authentication

### Critical Configuration Requirements
- **WIF Provider**: Must accept Firebase audience (`assertion.aud == "project-id"`)
- **Service Account Impersonation**: WIF principal must have `roles/iam.serviceAccountTokenCreator` on target SA
- **API Gateway Endpoints**: `/device-auth/initiate` and `/gcp-token/vend` with correct request body fields
- **Firebase Authentication**: Must enable "Custom" authentication provider in Firebase Console

### Current Working Configuration
- **API Gateway**: `https://anava-gateway-2gvbe0bn.uc.gateway.dev` (example from ryanclean project)
- **Test Project**: `ryanclean` (development project)
- **Authentication Status**: ✅ WORKING - Complete 3-step flow operational

## Common Development Patterns

### Terraform Module Structure
- Root module calls embedded module in `anava-desktop-app/terraform-module/`
- All Cloud Functions source code in `functions/` directory
- OpenAPI specifications templated in `api-gateway-config.yaml`
- Outputs provide all necessary configuration for cameras and app

### Electron IPC Communication
- Main process handles: GCP authentication, Terraform execution, camera discovery
- Renderer process: React UI with Material-UI components
- IPC channels: `terraform:progress`, `terraform:error`, `terraform:complete`

### Error Handling Strategy
- Detailed logging in Cloud Functions for debugging WIF issues
- Real-time progress updates during Terraform deployment
- Comprehensive error messages with actionable guidance

## Architecture Evolution Context

### Recent Major Achievements (July 2025)
- ✅ **Authentication Flow**: Complete 3-step camera authentication working
- ✅ **WIF Configuration**: Fixed Firebase audience acceptance issues
- ✅ **Service Account Permissions**: Resolved impersonation permission issues
- ✅ **API Gateway**: Fixed endpoint paths and request body field mismatches
- ✅ **Electron App**: Restored GCP auth, added project selection, setup guidance

### Autonomy Status: 100% Customer-Owned
- **No Anava Infrastructure Required**: All services deploy to customer's GCP project
- **Complete Data Sovereignty**: Customer data never leaves their environment
- **Zero Vendor Lock-in**: Customer owns all infrastructure components
- **Global Deployment Ready**: Works in any GCP region with any Google Cloud account

## Future Development Notes

### UX/UI Modernization Planned
- Professional onboarding flow design needed
- Streamlined deployment experience ("Anava Personal Cloud" branding)
- ACAP deployment integration with cloud configuration
- Manual action todo lists with future chat interface integration

### Distribution Model Ready
- App can be packaged for download from anava.ai
- No ongoing Anava infrastructure dependencies
- Pure software licensing business model viable
- Enterprise white-label opportunities available

## Critical Implementation Details (DO NOT REGRESS)

### Billing Detection
- **NEVER use Cloud Billing API** - It requires the API to be enabled first
- **ALWAYS use storage bucket creation** to test billing (creates temporary test bucket)
- Implementation: `anava-desktop-app/src/main/services/gcpAuthService.js` - `checkBillingEnabled()` method

### Cloud Build Permissions
- **New GCP projects REQUIRE explicit permissions** for Cloud Build service account
- Without these, Cloud Functions v2 deployment fails with "missing permission on build service account"
- Fix is in `anava-desktop-app/terraform-module/main.tf` - `cloud_build_permissions` resources

### Deployment Validation
- **ALWAYS validate Terraform outputs** before declaring success
- **ATTEMPT RECOVERY** when outputs are missing (use gcloud commands or placeholders)
- **DO NOT fail completely** for partial deployments - allow continuation with warnings
- Implementation: `anava-desktop-app/src/main/services/outputValidator.js`

### Development Environment
- **Git Worktrees**: This project uses worktrees - verify you're in `/worktrees/auth-fix/`
- **React Development**: Use `NODE_ENV=development npm run dev` or changes won't reflect
- **Multiple File Versions**: Check for duplicate files in different directories

### Known Working Projects
- `ryanclean`: Has complete working authentication infrastructure
- `thiswillwork-463601`: Has existing infrastructure that can be reused

### API Gateway Deployment Timing (CRITICAL)
- **API Gateway creation takes 10-15 minutes** - DO NOT timeout early
- Recovery mechanism waits up to 15 minutes with progress updates
- Implementation: `outputValidator.js` - 30 retries × 30 seconds
- Always check for API configurations first to detect deployment in progress

### UI/UX Critical Fixes
- **Logs MUST remain visible during errors** - separated from deployment progress
- Progress tracking uses actual Terraform stages: auth, init, plan, apply, configure
- Version number shown inline with app title for easy verification
- ACAP scanning is manual, not automatic on component mount

### Latest Stable Version
- v1.0.22: Fixed API Gateway timeout, logs visibility, progress tracking
- Terraform updated to 1.12.2 (from 1.5.7) for better stability

## Critical Files for Future Sessions

- `AUTHENTICATION_WORKING.md` - Complete working configuration status
- `ARCHITECTURE_ANALYSIS.md` - Business model and autonomy assessment  
- `test-firebase-exchange.sh` - End-to-end authentication flow validation
- `anava-desktop-app/src/renderer/src/components/SetupWizard.tsx` - Main setup flow UI
- `anava-desktop-app/src/main/services/gcpAuthService.js` - Billing detection logic
- `anava-desktop-app/src/main/services/outputValidator.js` - Deployment validation
- `functions/token-vending-machine/main.py` - Core WIF token exchange logic
- `main.tf` - Complete infrastructure definition